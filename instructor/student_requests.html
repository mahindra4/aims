<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        tbody tr:not(.clicked):hover{
            background-color: #f2f2f2;
        }
        .clicked{
            background-color: #b3e0ff;
        }
    </style>
</head>
<body>
    <div>
        <a href="add_courses.html">
            add courses
        </a>
        <a href="student_requests.html">
            student requests
        </a>
    </div>
    <h4 id="email"></h4>
    <h4>role: instructor</h4>
    <table>
        <thead>
            <tr bgcolor="gray">
                <th>email</th>
                <th>course</th>
            </tr>
        </thead>
        <tbody id="student-requests">
        </tbody>
    </table>
    <br>
    <button id="accept">accept</button>
    <br>
    <button id="logout">logout</button>
    <script>
        const PORT = 33333;
        
        let email = localStorage.getItem("email")

        //
        // email = 'a';
        document.getElementById("logout").addEventListener('click',(event)=>{
            localStorage.removeItem('email')
            window.location = '../login.html'
        })
        document.getElementById("email").innerHTML = "user: "+email;
        async function syncronize(){
            const response = await fetch(`http://localhost:${PORT}/student_requests`,{
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify({
                    email: email
                }) 
            })
            const data = await response.json();
            // console.log(data);
            tbody = document.getElementById('student-requests');
            data.forEach(item=>{
                element = `
                    <tr bgcolor="lightgray">
                        <td>${item.student_email}</td>
                        <td>${item.course}</td>
                    </tr>
                `
                tbody.innerHTML+=element;
            })
            document.querySelectorAll('#student-requests tr').forEach(row=>{
            row.addEventListener('click',(event)=>{
                row.classList.toggle('clicked');
            })
        })
        }
        syncronize()

        document.getElementById('accept').addEventListener('click',async (event)=>{
            const selected_rows = [];
            document.querySelectorAll('#student-requests tr').forEach(row=>{
                if(row.classList.contains('clicked')){
                    // selected elements
                    const rows = row.querySelectorAll('td')
                    const email = rows[0].textContent;
                    const course = rows[1].textContent;
                    selected_rows.push({
                        email: email,
                        course: course
                    })
                    row.remove()
                }
            })
            // selected_rows.forEach(item => console.log(item))
            const response = await fetch(`http://localhost:${PORT}/student_requests/instructor_approved`,{
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    selected_rows: selected_rows
                })
            }) 
            const data = await response.text();
            console.log(data);
        })

    </script>
</body>
</html>